name: Deploy to production

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Login to Alibaba Cloud Container Registry
        uses: docker/login-action@v2
        with:
          registry: registry.cn-chengdu.aliyuncs.com
          username: ${{ secrets.ALICLOUD_USERNAME }}
          password: ${{ secrets.ALICLOUD_PASSWORD }}

      - name: Build and push Docker image
        run: |
          # è¯»å– package.json ä¸­çš„ç‰ˆæœ¬å·
          IMAGE_TAG=$(jq -r '.version' package.json)
          IMAGE=registry.cn-chengdu.aliyuncs.com/ray321/ray
          echo "ğŸ›  ä½¿ç”¨ version: $IMAGE_TAG æ‰“æ ‡ç­¾"
          docker build -t $IMAGE:latest -t $IMAGE:$IMAGE_TAG .
          docker push $IMAGE:latest
          docker push $IMAGE:$IMAGE_TAG
          # ä¿å­˜ version ç»™åç»­æ­¥éª¤ç”¨ï¼ˆå¦‚ kubectlï¼‰
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "latest"

      - name: Decode kubeconfig and deploy to k3s
        env:
          KUBECONFIG_B64: ${{ secrets.KUBECONFIG }}
        run: |
          set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_B64" | base64 --decode > $HOME/.kube/config
          export KUBECONFIG=$HOME/.kube/config

          echo "ğŸ§ª æ ¡éªŒ kubeconfig æ˜¯å¦æœ‰æ•ˆ..."
          kubectl config view
          kubectl cluster-info || { echo "âŒ kubeconfig æ— æ•ˆæˆ–æ— æ³•è¿æ¥é›†ç¾¤"; exit 1; }

          echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
          IMAGE=registry-vpc.cn-chengdu.aliyuncs.com/ray321/ray

          echo "ğŸ”§ éƒ¨ç½²é•œåƒï¼š$IMAGE:$IMAGE_TAG"
          kubectl set image deployment/portal-base-web-deployment portal-base-web=$IMAGE:$IMAGE_TAG
          kubectl rollout status deployment/portal-base-web-deployment
