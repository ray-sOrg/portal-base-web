name: Deploy to production

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production # ðŸ‘ˆ å…³é”®ç‚¹ï¼ŒæŒ‡å®šä½¿ç”¨å“ªä¸ªçŽ¯å¢ƒï¼ˆç»‘å®š secretsï¼‰

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Login to Alibaba Cloud Container Registry
        uses: docker/login-action@v2
        with:
          registry: registry.cn-chengdu.aliyuncs.com
          username: ${{ secrets.ALICLOUD_USERNAME }}
          password: ${{ secrets.ALICLOUD_PASSWORD }}

      - name: Build and push Docker image
        run: |
          IMAGE_TAG=${{ github.sha }}
          IMAGE=registry.cn-chengdu.aliyuncs.com/ray321/ray

          docker build -t $IMAGE:latest -t $IMAGE:$IMAGE_TAG .
          docker push $IMAGE:latest
          docker push $IMAGE:$IMAGE_TAG

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "latest"

      - name: Decode kubeconfig and deploy to k3s
        env:
          KUBECONFIG_B64: ${{ secrets.KUBECONFIG }}
        run: |
          echo "$KUBECONFIG_B64" | base64 --decode > $HOME/.kube/config
          IMAGE_TAG=${{ github.sha }}
          IMAGE=registry.cn-chengdu.aliyuncs.com/ray321/ray
          kubectl set image deployment/portal-base-web-deployment portal-base-web=$IMAGE:$IMAGE_TAG
          kubectl rollout status deployment/portal-base-web-deployment
